# タスク管理

## 現在のタスク

- [~] プロフィールリンク機能のUI修正（feature/profile-link-generation ブランチ）
  - [x] 1. DB設計・マイグレーション確認
    - [x] profile_linksテーブル（user_id, token, expires_at, is_active, created_at）を確認済み
    - [x] トークン生成時に「作成日時」を組み込む方式（hash(user_id + ランダム値 + 作成日時)）
    - [x] 有効期限は「3日（72時間）」で統一
  - [x] 2. モデル・リレーション修正
    - [x] ProfileLinkモデル・UserモデルのprofileLinksリレーションを確認
    - [x] トークン生成・有効期限・一意性ロジックの強化（作成日時組み込み）
    - [x] 期限切れ・手動無効化時はDBから完全削除
  - [x] 3. コントローラ・ルート設計
    - [x] /profile-link/{token} ルート追加
    - [x] 期限切れ時は「期限切れ」画面＋/postsリダイレクト
    - [x] 有効期間中は再生成不可、手動無効化は可能（確認ダイアログ付き）
  - [x] 4. Blade/UI実装
    - [x] マイプロフィール画面（profile/partials/profile-card.blade.php）に「プロフィールリンク作成」ボタン追加（編集ボタンの上）
    - [x] 有効期間中は「プロフィールリンク表示」ボタンに切り替え
    - [x] インライン展開方式でリンク表示・有効期限・コピー・無効化ボタンを実装
    - [x] 無効化ボタン押下時は確認ダイアログ→OKで完全削除
  - [x] 5. コピー機能
    - [x] Clipboard API＋execCommand＋手動コピー案内の実装
    - [x] コピー失敗時は「手動でコピーしてください」と案内
  - [x] 6. アクセス制御・認可
    - [x] プライベートアカウントの場合はフォロー申請画面のみ表示、投稿は非表示
    - [x] 有効期限・無効化後はトークン無効化
  - [~] 7. UI修正対応
    - [x] 閉じるボタン表示問題の修正（toggleProfileLinkDisplay/closeProfileLinkDisplay関数分離）
    - [!] 左カードの高さ設定問題（sticky top-16使用、適切な高さ設定が必要）
    - [x] リンク無効化後の状態更新問題（resetProfileLinkUI関数をリロードに単純化）
    - [x] プロフィールリンク作成時の自動表示機能（sessionStorageフラグ + DOMContentLoaded自動表示）
  - [ ] 8. 最終動作確認
    - [ ] 有効期限・無効化・再利用リスク・UI/UXの動作確認
    - [ ] エラー・例外時のハンドリング
    - [ ] ドキュメント・todo更新

#### 【背景・目的】
- プライベートアカウントでも友人等に安全にプロフィールを共有できるようにする
- 検索機能の煩雑化を避け、招待制・限定公開の体験を実現する
- セキュリティ・運用面でのリスクを最小化するため、トークンの一意性・有効期限・無効化機能を厳格に設計

#### 【仕様要点】
- 有効期限は3日（72時間）
- トークンは作成日時を組み込んだランダム値
- 期限切れ・手動無効化時はDBから完全削除
- 期限切れ時は「期限切れ」画面＋/postsリダイレクト
- 有効期間中は再生成不可、手動無効化は可能
- コピー機能はClipboard API＋execCommand＋手動案内

### 🔴 緊急タスク
- [~] **Phase 16-2: デプロイ後重要修正**
  - [x] 投稿作成画面で店舗名を候補から必ず選択させる仕様変更
  - [~] プロフィールリンク機能の実装（feature/profile-link-generation ブランチ）
  - [ ] 投稿一覧画面で新着タブに移動できない問題修正
  - [ ] 投稿詳細ページで投稿の編集・削除を3点リーダーからボタンに変更
  - [ ] アカウント削除機能の動作確認・修正


### 🟡 重要タスク
- [ ] **Phase 16-3: UI/UX改善**
  - [ ] 店舗詳細画面で投稿タブのみカードのサイズが違うUI修正
  - [ ] Google Mapのスタイル適用完了
  - [ ] 通知のアイコンデザイン修正
  - [ ] アカウント設定のデータエクスポート機能削除

### 🟢 通常タスク


### ⚪ 将来的タスク
- [ ] **Phase 17: 新機能実装**
  - [ ] **プロフィールリンク機能のHTML重複ID問題の根本解決**
    - [ ] profile/show.blade.phpでモバイル用・PC用の重複コンポーネント問題解決
    - [ ] モーダルの共通化実装（1つのモーダルを2つのカードで共有）
    - [ ] W3C HTML標準準拠（id属性重複の完全排除）
    - [ ] レスポンシブデザインベストプラクティス適用
    - [ ] アクセシビリティ向上（予期しない動作の防止）
    - [ ] 保守性向上（1つのモーダル管理に統一）
  - [ ] サジェストUI・Alpine関数・key設計の共通化リファクタリングを検討（画面ごとのprops/mode分岐で柔軟に対応）
  - [ ] 投稿にカテゴリ機能を搭載し、それを用いた検索機能を追加
  - [ ] エリアに絞った検索機能を実装
  - [ ] フォロー・アンフォローの非同期UI更新実装
    - リロード/リダイレクト方式から非同期での即時UI反映に変更
    - ボタン表示・カウント・その他UI要素の即時更新
- [ ] プライベートアカウントの投稿および「非表示」設定の投稿は、未認可ユーザーから閲覧できないようにする
  - [ ] 投稿詳細・一覧・APIレスポンスでの認可ロジック強化
  - [ ] Blade/JS側でのUI非表示制御
  - [ ] テスト・動作確認
- [ ] エラーや通知などの表示内容の最適化（専門用語の排除・一般ユーザー向け表現）
- [ ] プロフィールリンク再生成機能の実装（有効期間中でも再生成・手動無効化後の再生成を可能にする拡張）


### 🔵 Google Maps API関連の将来実装予定
- [ ] **Phase 18: Google Maps API最適化・機能強化**
  - [ ] Google Maps JavaScript APIの警告対応
    - [ ] Marker非推奨警告の対応（AdvancedMarkerElementへの移行）
    - [ ] loading=async未使用警告の対応
    - [ ] 最新のGoogle Maps API仕様への完全対応
  - [ ] 地図スタイルのカスタマイズ
    - [ ] カスタムマーカーアイコンの実装（店舗タイプ別アイコン）
    - [ ] 地図テーマのカスタマイズ（ダークモード対応）
    - [ ] マーカークラスタのデザインカスタマイズ
  - [ ] インタラクティブ機能の強化
    - [ ] ホバー時の店舗情報表示（店舗名・営業時間・評価等）
    - [ ] マーカークリック時の詳細情報ウィンドウ
    - [ ] 地図上での検索機能（現在地周辺検索）
    - [ ] ルート案内機能の実装
  - [ ] パフォーマンス最適化
    - [ ] ビューポート内レンダリング最適化
    - [ ] マーカーの遅延読み込み
    - [ ] 地図データの段階的読み込み
  - [ ] レスポンシブ対応の確認・改善
    - [ ] スマホ・タブレット幅での地図高さ・UI崩れの確認
    - [ ] モバイル専用の地図操作UI
    - [ ] タッチ操作の最適化
  - [ ] セキュリティ強化
    - [ ] APIキーの制限設定（ドメイン制限・リファラー制限）
    - [ ] 使用量監視ダッシュボードの実装
    - [ ] 異常検知・アラート機能の実装
  - [ ] データベース最適化
    - [ ] 店舗座標データのインデックス最適化
    - [ ] 地理空間クエリの実装（PostGIS等）
    - [ ] 近隣店舗検索の高速化
  - [ ] ユーザビリティ改善
    - [ ] 地図上での店舗お気に入り機能
    - [ ] 地図表示設定の保存機能
    - [ ] 地図履歴機能（最近見た店舗）
  - [ ] 統合機能の強化
    - [ ] 投稿作成時の地図連携強化
    - [ ] 店舗詳細ページでの地図表示
    - [ ] ユーザープロフィールでの訪問店舗地図表示

## 完了済みタスク


## 一時停止中のタスク

### Phase 15: Google Maps API連携実装（一時停止）
- **停止理由**: Phase 16完了後に再開予定
- **残りタスク**: 
  - 地図スタイルのカスタマイズ
  - カスタムマーカーアイコン
  - インタラクティブ機能の強化
  - セキュリティ強化（APIキー制限設定）

## 問題のあるタスク

- [!] なし

## 今後の予定タスク


### 今後のアップデート方針（画像アップロード機能）
- 複数画像アップロード（サブ画像ギャラリー、ドラッグ＆ドロップ、並び替え等）は将来的な拡張候補。
- 現状は「1枚のみアップロード」でリリースし、リッチなUI/UXはリリース後の段階的アップデートで対応。


## メモ

- コメント削除のダイアログは標準confirm()のため、カスタムモーダル化しない限りautofocus制御不可
- UIアクセシビリティ改善は段階的に進める
- Google Mapsの警告（Marker非推奨、loading=async未使用）は現状の地図表示には影響なし。今後のリファクタリングで対応予定。
- レスポンシブ対応（スマホ・タブレット幅での地図高さ・UI崩れ）は未確認。必要に応じてTailwindのレスポンシブクラスや@mediaクエリで調整予定。
- **2025年6月29日**: Phase 16-1の大部分が完了し、残りはいいね機能の修正と検索機能の曖昧検索対応のみ
- **現在の優先タスク**: Phase 16-1 残りタスクの完了 → Phase 16-2 重要修正の開始
- **一時停止中のタスク**: Phase 15 Google Maps API連携実装（Phase 16完了後に再開予定）

## 環境情報

### 現在の環境状況
- **Docker環境**: 正常稼働中
  - portfolio_app (PHP 8.2.28)
  - portfolio_nginx (Nginx 1.18.0)
  - portfolio_mysql (MySQL)
- **Laravel**: 10.48.29
- **データベース**: マイグレーション完了（23個）
- **フロントエンド**: Vite + Tailwind CSS
- **アクセスURL**: http://localhost
- **本番ドメイン**: https://taste-retreat.com

### 確認済み機能
- アプリケーション起動: ✅
- データベース接続: ✅
- マイグレーション: ✅
- フロントエンドビルド: ✅
- Webサーバー: ✅

### ルールファイル構成（8つ）
- `.cursor/rules/core-rules.mdc`: 基本開発ルール（常に適用）
- `.cursor/rules/beginner-guidelines.mdc`: 初心者向け解説方針（常に適用）
- `.cursor/rules/laravel-backend.mdc`: Laravelバックエンド開発時のみ参照（AutoAttached）
- `.cursor/rules/tailwind-frontend.mdc`: フロントエンド開発時のみ参照（AutoAttached）
- `.cursor/rules/error-handling.mdc`: エラー対応時のみ参照（AgentRequested）
- `.cursor/rules/task-management.mdc`: タスク管理時のみ参照（AgentRequested）
- `.cursor/rules/knowledge-management.mdc`: 技術的ナレッジベース管理時のみ参照（AgentRequested）
- `.cursor/rules/qa-knowledge.mdc`: 開発Q&A記録時のみ参照（AgentRequested）


- ルールファイルが正常に作成されました
- タスク管理システムが稼働開始しました
- 環境セッティングが完了し、開発準備が整いました
- アプリケーションは http://localhost でアクセス可能です
- **現在の優先タスク**: Phase 16-1 残りタスクの完了 → Phase 16-2 重要修正の開始
- **一時停止中のタスク**: Phase 15 Google Maps API連携実装（Phase 16完了後に再開予定）
- リファクタリングの基本原則：1コンポーネント1機能、拡張性より単純性、可読性最優先、保守性重視、Tailwindクラス直接記述
- **新しいルール体系**: 8つのルールファイルで包括的な開発ガイドラインを構築
- **ルール見落とし防止**: 作業開始前に必ず全てのルールファイルを参照し、適用状況を確認

## 現在のコンポーネント状況

### x-atoms.avatar コンポーネント
- **現状**: 機能改善完了
- **機能**: 
  - アバター画像表示（`$user->avatar_url`）
  - 頭文字表示（日本語対応、`AvatarHelper::getInitial()`）
  - サイズ調整（small, default, large）
  - プライベートアイコン表示（統合済み）
- **使用箇所**: 
  - `post-card.blade.php`（size="small"）
  - その他のコンポーネントで適切に使用中

### 通知ドロップダウンと/notifications一覧ページのUI統一（将来実装予定）
  - 現状は/notificationsへのリンクのみ設置
  - ドロップダウンと一覧の両立はUI不整合リスクがあるため、今後の課題として記録