# タスク管理

## 現在のタスク

### 🔴 緊急タスク
- [ ] **Phase 16-1: デプロイ後緊急修正（残りタスク）**
  - [~] 投稿のいいね機能の動作確認・修正
    - [x] 3. 現状のエラーハンドリングの流れを整理
    - [x] 【A】全体像の把握
      - [x] 1. いいね機能に関わるファイル一覧を整理
      - [x] 2. 処理の流れ（リクエスト→コントローラ→レスポンス→JS→UI更新）を図式化・言語化
    - [x] 4. どこで例外や不整合が起きているか仮説を複数立てる
    - [x] 5. それぞれの仮説に対し検証方法を明示
    - [x] 【C】調査・検証
      - [x] 6. 各ファイル・コードの該当箇所を順に確認（Blade, JS, Controller, Model, ルート, DB構造など）
      - [x] 7. ネットワークタブ・コンソールログで実際のリクエスト/レスポンス/エラー内容を再確認
      - [x] 8. セッション・CSRF・認可の状態も確認
    - [ ] 【D】改善プラン
      - [x] 9. 問題点が明確になったら修正方針を提案
      - [x] 10. 段階的に修正・動作確認を行う
        - [x] 10-1. Bladeテンプレート（post-actions.blade.php等）の「いいね」ボタン・SVG構造を精査
        - [x] 10-2. JS（post-like.js）のイベントバインド・DOM取得タイミングを精査
        - [x] 10-3. UI再描画時のイベント再バインド・構造変化の有無を調査
        - [x] 10-4. 原因特定後、修正案を提案
        - [x] 10-5. 修正実装・動作確認
    - [x] プロフィール画面で「いいね数0でもハートが赤い」事象の修正（情報取得・UI更新の最適化）
  - [ ] 検索機能の曖昧検索（ひらがな入力等）対応
    - [~] 【現状の詳細・進捗メモ（2025/06/29時点）】
      - 投稿作成画面の店舗検索で「店舗選択後に投稿ボタンがグレーアウト」「リロード直後にAlpine.jsのnullアクセスエラー（Cannot read properties of null (reading 'name'/'address')）」が発生中。
      - 検索・候補選択・バリデーションAPI（/api/shops/validate-selection）は正常に動作し、success: trueが返っている。
      - ただし、isSelectionValidがtrueにならず、投稿ボタンが有効化されない。
      - Blade/Alpine.js側でselectedShopがnullのまま.name/.addressにアクセスしている箇所が残っている可能性。
      - 投稿ボタンのdisabled属性の制御ロジック、Alpine.jsの状態遷移、validateSelectionメソッドの挙動を要再調査。
    - [ ] 【次回開始時に着手すること】
      - shop-search.blade.phpの全ての.name/.addressアクセス箇所でガード漏れがないか再点検・修正。
      - 投稿ボタンのdisabled条件（isSelectionValid, selectedShop, 他必須項目）を確認し、必要に応じて修正。
      - Alpine.jsの状態遷移（店舗選択→バリデーション→ボタン有効化）が正しく動作しているか、console.log等でデバッグ。
      - 必要に応じてshop-search.jsのvalidateSelectionメソッドの中身も確認・修正。
      - 上記の調査・修正後、再度リロード直後のエラー消失・店舗選択後の投稿ボタン有効化を動作確認する。

### 🟡 重要タスク
- [ ] **Phase 16-2: デプロイ後重要修正**
  - [ ] 投稿作成画面で店舗名を候補から必ず選択させる仕様変更
  - [ ] プライベートアカウント時のプロフィールリンク作成修正
  - [ ] 投稿一覧画面で新着タブに移動できない問題修正
  - [ ] 投稿詳細ページで投稿の編集・削除を3点リーダーからボタンに変更
  - [ ] アカウント削除機能の動作確認・修正

### 🟢 通常タスク
- [ ] **Phase 16-3: UI/UX改善**
  - [ ] 店舗詳細画面で投稿タブのみカードのサイズが違うUI修正
  - [ ] Google Mapのスタイル適用完了
  - [ ] 通知のアイコンデザイン修正
  - [ ] アカウント設定のデータエクスポート機能削除

### ⚪ 将来的タスク
- [ ] **Phase 17: 新機能実装**
  - [ ] 投稿にカテゴリ機能を搭載し、それを用いた検索機能を追加
  - [ ] エリアに絞った検索機能を実装
  - [ ] フォロー・アンフォローの非同期UI更新実装
    - リロード/リダイレクト方式から非同期での即時UI反映に変更
    - ボタン表示・カウント・その他UI要素の即時更新
- [ ] プライベートアカウントの投稿および「非表示」設定の投稿は、未認可ユーザーから閲覧できないようにする
  - [ ] 投稿詳細・一覧・APIレスポンスでの認可ロジック強化
  - [ ] Blade/JS側でのUI非表示制御
  - [ ] テスト・動作確認
- [ ] エラーや通知などの表示内容の最適化（専門用語の排除・一般ユーザー向け表現）

### 🔵 Google Maps API関連の将来実装予定
- [ ] **Phase 18: Google Maps API最適化・機能強化**
  - [ ] Google Maps JavaScript APIの警告対応
    - [ ] Marker非推奨警告の対応（AdvancedMarkerElementへの移行）
    - [ ] loading=async未使用警告の対応
    - [ ] 最新のGoogle Maps API仕様への完全対応
  - [ ] 地図スタイルのカスタマイズ
    - [ ] カスタムマーカーアイコンの実装（店舗タイプ別アイコン）
    - [ ] 地図テーマのカスタマイズ（ダークモード対応）
    - [ ] マーカークラスタのデザインカスタマイズ
  - [ ] インタラクティブ機能の強化
    - [ ] ホバー時の店舗情報表示（店舗名・営業時間・評価等）
    - [ ] マーカークリック時の詳細情報ウィンドウ
    - [ ] 地図上での検索機能（現在地周辺検索）
    - [ ] ルート案内機能の実装
  - [ ] パフォーマンス最適化
    - [ ] ビューポート内レンダリング最適化
    - [ ] マーカーの遅延読み込み
    - [ ] 地図データの段階的読み込み
  - [ ] レスポンシブ対応の確認・改善
    - [ ] スマホ・タブレット幅での地図高さ・UI崩れの確認
    - [ ] モバイル専用の地図操作UI
    - [ ] タッチ操作の最適化
  - [ ] セキュリティ強化
    - [ ] APIキーの制限設定（ドメイン制限・リファラー制限）
    - [ ] 使用量監視ダッシュボードの実装
    - [ ] 異常検知・アラート機能の実装
  - [ ] データベース最適化
    - [ ] 店舗座標データのインデックス最適化
    - [ ] 地理空間クエリの実装（PostGIS等）
    - [ ] 近隣店舗検索の高速化
  - [ ] ユーザビリティ改善
    - [ ] 地図上での店舗お気に入り機能
    - [ ] 地図表示設定の保存機能
    - [ ] 地図履歴機能（最近見た店舗）
  - [ ] 統合機能の強化
    - [ ] 投稿作成時の地図連携強化
    - [ ] 店舗詳細ページでの地図表示
    - [ ] ユーザープロフィールでの訪問店舗地図表示

## 完了済みタスク（最新）

### Phase 16-1: デプロイ後緊急修正（2025年6月29日完了）
- [x] ログイン後の遷移先をダッシュボードから/postsに変更
- [x] ユーザーページのCSS適用・UI高さ揃え・レスポンシブ修正
- [x] 新規店舗選択→投稿作成バグ修正
- [x] 投稿編集ページの追加修正
- [x] フォロー機能の動作確認・修正
- [x] フォロワー・フォロー中リスト表示機能の修正
- [x] フォロー/フォロワーリスト・通知UI/ロジック修正

**まとめ**: ログイン後遷移・ユーザーページUI・新規店舗選択→投稿作成・投稿編集・フォロー機能の全問題を解決。特にhiddenフィールドのname属性不一致という根本原因を特定・修正し、Google Places API連携の新規店舗選択時も投稿が保存できるようになった。

---

### Phase 15: Google Maps API連携実装（2025年6月27日完了）
- [x] Phase 15-1: 基盤構築（環境設定・データベース設計・サービス層実装・モデル層実装・評価機能削除）
- [x] Phase 15-2: 情報取得機能実装（店舗検索・重複対策）
- [x] Phase 15-3: マッピング機能実装（地図表示・マーカー表示・クラスタリング）
- [x] Phase 15-4: 最適化・セキュリティ（キャッシュ戦略・レート制限・監視システム）

**まとめ**: Google Places API連携の全機能が実装完了。地図表示・マーカー表示・クラスタリング機能が全て正常動作し、キャッシュ戦略・レート制限・監視システムも実装済み。

---

### 過去の完了タスク
詳細は `src/todo-archive.md` を参照してください。
- **Phase 1-14**: プロジェクト構造分析、Atomsリファクタリング、コメント非同期化、ルール最適化、JavaScript簡略化、CSS統合、最終確認とクリーンアップ、画像アップロード機能のCloudinary移行など

## 一時停止中のタスク

### Phase 15: Google Maps API連携実装（一時停止）
- **停止理由**: Phase 16完了後に再開予定
- **残りタスク**: 
  - 地図スタイルのカスタマイズ
  - カスタムマーカーアイコン
  - インタラクティブ機能の強化
  - セキュリティ強化（APIキー制限設定）

## 問題のあるタスク

- [!] なし

## 今後の予定タスク

### Phase 12: 最終確認とクリーンアップ（一時停止中）
<!-- このセクションはアーカイブに移動します -->

### Phase 13: 店舗検索機能の実装（一時停止中）
- [ ] 検索機能の不具合調査・修正
  - [ ] サジェストバーが正常動作しない原因の特定
  - [ ] 必要に応じてAPI・Blade・JSの修正

### 今後のアップデート方針（画像アップロード機能）
- 複数画像アップロード（サブ画像ギャラリー、ドラッグ＆ドロップ、並び替え等）は将来的な拡張候補。
- 現状は「1枚のみアップロード」でリリースし、リッチなUI/UXはリリース後の段階的アップデートで対応。

## 次フェーズ以降のタスク
- [ ] ユーザー削除ボタンが表示されない問題の調査・対応
  - [ ] プロフィール編集画面で「アカウント削除」ボタンが表示されない原因を調査し、必要に応じてBlade/認可/ルーティング等を修正

## メモ

- コメント削除のダイアログは標準confirm()のため、カスタムモーダル化しない限りautofocus制御不可
- UIアクセシビリティ改善は段階的に進める
- Google Mapsの警告（Marker非推奨、loading=async未使用）は現状の地図表示には影響なし。今後のリファクタリングで対応予定。
- レスポンシブ対応（スマホ・タブレット幅での地図高さ・UI崩れ）は未確認。必要に応じてTailwindのレスポンシブクラスや@mediaクエリで調整予定。
- **2025年6月29日**: Phase 16-1の大部分が完了し、残りはいいね機能の修正と検索機能の曖昧検索対応のみ
- **現在の優先タスク**: Phase 16-1 残りタスクの完了 → Phase 16-2 重要修正の開始
- **一時停止中のタスク**: Phase 15 Google Maps API連携実装（Phase 16完了後に再開予定）

## 環境情報

### 現在の環境状況
- **Docker環境**: 正常稼働中
  - portfolio_app (PHP 8.2.28)
  - portfolio_nginx (Nginx 1.18.0)
  - portfolio_mysql (MySQL)
- **Laravel**: 10.48.29
- **データベース**: マイグレーション完了（23個）
- **フロントエンド**: Vite + Tailwind CSS
- **アクセスURL**: http://localhost
- **本番ドメイン**: https://taste-retreat.com

### 確認済み機能
- アプリケーション起動: ✅
- データベース接続: ✅
- マイグレーション: ✅
- フロントエンドビルド: ✅
- Webサーバー: ✅

### ルールファイル構成（8つ）
- `.cursor/rules/core-rules.mdc`: 基本開発ルール（常に適用）
- `.cursor/rules/beginner-guidelines.mdc`: 初心者向け解説方針（常に適用）
- `.cursor/rules/laravel-backend.mdc`: Laravelバックエンド開発時のみ参照（AutoAttached）
- `.cursor/rules/tailwind-frontend.mdc`: フロントエンド開発時のみ参照（AutoAttached）
- `.cursor/rules/error-handling.mdc`: エラー対応時のみ参照（AgentRequested）
- `.cursor/rules/task-management.mdc`: タスク管理時のみ参照（AgentRequested）
- `.cursor/rules/knowledge-management.mdc`: 技術的ナレッジベース管理時のみ参照（AgentRequested）
- `.cursor/rules/qa-knowledge.mdc`: 開発Q&A記録時のみ参照（AgentRequested）

## 今後の予定

### 日次更新
- 進捗状況の確認
- ブロッカーの特定
- 次のアクションの決定

### 週次レビュー
- 完了タスクの確認
- 未完了タスクの再評価
- 新規タスクの追加

### 月次振り返り
- パフォーマンスの評価
- 改善点の特定
- 次のマイルストーンの設定

## メモ

- ルールファイルが正常に作成されました
- タスク管理システムが稼働開始しました
- 環境セッティングが完了し、開発準備が整いました
- アプリケーションは http://localhost でアクセス可能です
- **現在の優先タスク**: Phase 16-1 残りタスクの完了 → Phase 16-2 重要修正の開始
- **一時停止中のタスク**: Phase 15 Google Maps API連携実装（Phase 16完了後に再開予定）
- リファクタリングの基本原則：1コンポーネント1機能、拡張性より単純性、可読性最優先、保守性重視、Tailwindクラス直接記述
- **新しいルール体系**: 8つのルールファイルで包括的な開発ガイドラインを構築
- **ルール見落とし防止**: 作業開始前に必ず全てのルールファイルを参照し、適用状況を確認

## 現在のコンポーネント状況

### x-atoms.avatar コンポーネント
- **現状**: 機能改善完了
- **機能**: 
  - アバター画像表示（`$user->avatar_url`）
  - 頭文字表示（日本語対応、`AvatarHelper::getInitial()`）
  - サイズ調整（small, default, large）
  - プライベートアイコン表示（統合済み）
- **使用箇所**: 
  - `post-card.blade.php`（size="small"）
  - その他のコンポーネントで適切に使用中

### 通知ドロップダウンと/notifications一覧ページのUI統一（将来実装予定）
  - 現状は/notificationsへのリンクのみ設置
  - ドロップダウンと一覧の両立はUI不整合リスクがあるため、今後の課題として記録