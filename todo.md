# タスク管理

## 🎯 **現在の最優先プロジェクト: TasteRetreat タブ機能修正**

### **プロジェクト概要**
投稿一覧画面のタブ機能修正を2段階で実装：
- **Phase A**: 既存タブ機能の修正（✅完了）
- **Phase B**: 人気タブの新規実装（✅完了）

### **Phase A: 既存タブ機能の修正** - ✅完了（2025年7月実装）

#### **実装内容**
- [x] **PostController@index修正**: タブパラメータ受け取り対応
- [x] **タブ順序変更**: 「新着」→「人気」の順、新着をデフォルト
- [x] **tab-navigationコンポーネント修正**: JavaScript連携実装
- [x] **エラー修正**: Blade構文とJavaScript競合の解決

#### **修正されたファイル**
- [x] `src/app/Http/Controllers/PostController.php`
- [x] `src/resources/views/post/index.blade.php`  
- [x] `src/resources/views/components/molecules/tab-navigation.blade.php`

#### **エラー解決履歴**
- [x] **問題**: `onclick="changeTab('{{ $tab['key'] }}')"` でクォートエスケープエラー
- [x] **解決**: `data-*`属性 + `addEventListener`方式で分離
- [x] **修正**: `@@props` → `@props`の誤記修正

#### **動作確認項目**
- [x] 新着タブがデフォルトで選択される
- [x] 投稿が新着順で表示される
- [x] 人気タブをクリックしてURLが変わる
- [x] 人気タブが空の状態で表示される
- [x] タブ切り替えが正常に動作する

### **Phase B: 人気タブ実装** - ✅完了（2025年7月実装）

#### **最終仕様**
- [x] **「新着」タブ**: 投稿を新着順で表示
- [x] **「人気」タブ**: 投稿をいいね数の多い順でTOP10表示

#### **実装内容**
- [x] **PostController@index修正**: 人気タブでいいね数順ソート実装
- [x] **タブ名調整**: 分かりやすい表記への調整
- [x] **動作確認**: 正常動作確認済み
- [x] **クリーンアップ**: 未使用コードの削除

#### **修正されたファイル**
- [x] `src/app/Http/Controllers/PostController.php` - 人気タブのクエリ実装
- [x] `src/resources/views/post/index.blade.php` - タブ名の設定
- [x] `src/app/Models/Shop.php` - 未使用メソッドの削除

#### **実装プロセス**
- [x] **Step 1**: 現状分析と実装計画の策定
- [x] **Step 2**: タブ名変更（「新着投稿」「人気店舗」）
- [x] **Step 3**: 人気度計算ロジックの実装（店舗お気に入り数ベース）
- [x] **仕様変更**: より分かりやすい「人気の投稿」（いいね数順）に変更
- [x] **最終調整**: TOP50→TOP10表示に調整
- [x] **クリーンアップ**: 未使用コードの削除

#### **動作確認項目**
- [x] 新着タブで新着順表示される
- [x] 人気タブでいいね数順（TOP10）表示される
- [x] タブ切り替えが正常に動作する
- [x] エラーが発生しない

#### **学んだポイント**
- **段階的実装の重要性**: 一歩ずつ実装し動作確認を行うことの大切さ
- **要件の柔軟な変更**: 複雑な仕様から分かりやすい仕様への変更判断
- **動作確認の徹底**: task-management.mdcルールに従った確認プロセス
- **クリーンアップの実施**: 未使用コードの適切な削除

---

## 現在のタスク

### 🔴 緊急タスク
- [ ] **Phase B開始前の準備**
  - [ ] Phase B実装計画の詳細化
  - [ ] 人気度計算の要件定義
  - [ ] 実装手順の段階的計画
  - [ ] 動作確認項目の明確化

### 🔴 緊急タスク
- [ ] **Phase 16-2: デプロイ後重要修正**
  - [x] 投稿作成画面で店舗名を候補から必ず選択させる仕様変更
  - [x] プロフィールリンク機能の実装（feature/profile-link-generation ブランチ）
  - [x] 投稿一覧画面で新着タブに移動できない問題修正 ⭐**Phase A完了により解決**
  - [ ] 投稿詳細ページで投稿の編集・削除を3点リーダーからボタンに変更
  - [ ] アカウント削除機能の動作確認・修正

### 🟡 重要タスク
- [ ] **🔄Phase B: 人気タブ実装** ⭐**現在進行中**
  - [ ] 店舗お気に入り数による人気度集計ロジック実装
  - [ ] PostController@indexに人気タブ用クエリ追加
  - [ ] Shop.phpにscopePopularWithPosts()メソッド追加
  - [ ] キャッシュ実装（1時間更新）
  - [ ] 投稿カードUI調整（人気度表示）
  - [ ] パフォーマンス最適化（N+1問題回避）
  - [ ] 動作確認・テスト

- [ ] **Phase 16-3: UI/UX改善**
  - [ ] 店舗詳細画面で投稿タブのみカードのサイズが違うUI修正
  - [ ] Google Mapのスタイル適用完了
  - [ ] 通知のアイコンデザイン修正
  - [ ] アカウント設定のデータエクスポート機能削除

### 🟢 通常タスク

### ⚪ 将来的タスク
- [ ] **Phase 17: 新機能実装**
  - [ ] **プロフィールリンク機能のHTML重複ID問題の根本解決**
    - [ ] profile/show.blade.phpでモバイル用・PC用の重複コンポーネント問題解決
    - [ ] モーダルの共通化実装（1つのモーダルを2つのカードで共有）
    - [ ] W3C HTML標準準拠（id属性重複の完全排除）
    - [ ] レスポンシブデザインベストプラクティス適用
    - [ ] アクセシビリティ向上（予期しない動作の防止）
    - [ ] 保守性向上（1つのモーダル管理に統一）
  - [ ] サジェストUI・Alpine関数・key設計の共通化リファクタリングを検討（画面ごとのprops/mode分岐で柔軟に対応）
  - [ ] 投稿にカテゴリ機能を搭載し、それを用いた検索機能を追加
  - [ ] エリアに絞った検索機能を実装
  - [ ] フォロー・アンフォローの非同期UI更新実装
    - リロード/リダイレクト方式から非同期での即時UI反映に変更
    - ボタン表示・カウント・その他UI要素の即時更新
- [ ] プライベートアカウントの投稿および「非表示」設定の投稿は、未認可ユーザーから閲覧できないようにする
  - [ ] 投稿詳細・一覧・APIレスポンスでの認可ロジック強化
  - [ ] Blade/JS側でのUI非表示制御
  - [ ] テスト・動作確認
- [ ] **プロフィール画面の左カード高さ調整機能**
  - [ ] 左カード（プロフィールカード）の高さを右カラム（投稿一覧）の最下端に合わせる動的調整機能
  - [ ] 無限スクロールでの投稿追加時の高さ自動再計算
  - [ ] 既存のsticky top-16動作を維持しながらの実装
  - [ ] ページ全体のスクロール時の高さ同期
  - [ ] 右カラムが短い場合は現在の最小高さ設定を維持
  - [ ] レスポンシブ対応（デスクトップでのみ動作、モバイルは現状維持）
  - [ ] パフォーマンス最優化（リアルタイム監視とDOM操作の効率化）
  - [ ] 実装理由：UI/UXの統一性向上、視覚的バランスの改善
- [ ] エラーや通知などの表示内容の最適化（専門用語の排除・一般ユーザー向け表現）
- [ ] プロフィールリンク再生成機能の実装（有効期間中でも再生成・手動無効化後の再生成を可能にする拡張）

### 🔵 Google Maps API関連の将来実装予定
- [ ] **Phase 18: Google Maps API最適化・機能強化**
  - [ ] Google Maps JavaScript APIの警告対応
    - [ ] Marker非推奨警告の対応（AdvancedMarkerElementへの移行）
    - [ ] loading=async未使用警告の対応
    - [ ] 最新のGoogle Maps API仕様への完全対応
  - [ ] 地図スタイルのカスタマイズ
    - [ ] カスタムマーカーアイコンの実装（店舗タイプ別アイコン）
    - [ ] 地図テーマのカスタマイズ（ダークモード対応）
    - [ ] マーカークラスタのデザインカスタマイズ
  - [ ] インタラクティブ機能の強化
    - [ ] ホバー時の店舗情報表示（店舗名・営業時間・評価等）
    - [ ] マーカークリック時の詳細情報ウィンドウ
    - [ ] 地図上での検索機能（現在地周辺検索）
    - [ ] ルート案内機能の実装
  - [ ] パフォーマンス最適化
    - [ ] ビューポート内レンダリング最適化
    - [ ] マーカーの遅延読み込み
    - [ ] 地図データの段階的読み込み
  - [ ] レスポンシブ対応の確認・改善
    - [ ] スマホ・タブレット幅での地図高さ・UI崩れの確認
    - [ ] モバイル専用の地図操作UI
    - [ ] タッチ操作の最適化
  - [ ] セキュリティ強化
    - [ ] APIキーの制限設定（ドメイン制限・リファラー制限）
    - [ ] 使用量監視ダッシュボードの実装
    - [ ] 異常検知・アラート機能の実装
  - [ ] データベース最適化
    - [ ] 店舗座標データのインデックス最適化
    - [ ] 地理空間クエリの実装（PostGIS等）
    - [ ] 近隣店舗検索の高速化
  - [ ] ユーザビリティ改善
    - [ ] 地図上での店舗お気に入り機能
    - [ ] 地図表示設定の保存機能
    - [ ] 地図履歴機能（最近見た店舗）
  - [ ] 統合機能の強化
    - [ ] 投稿作成時の地図連携強化
    - [ ] 店舗詳細ページでの地図表示
    - [ ] ユーザープロフィールでの訪問店舗地図表示

## 完了済みタスク

### **Phase A: 既存タブ機能の修正** - ✅完了（2025年1月実装）
- [x] **PostController@index修正**: タブパラメータ受け取り対応
- [x] **タブ順序変更**: 「新着」→「人気」の順、新着をデフォルト
- [x] **tab-navigationコンポーネント修正**: JavaScript連携実装
- [x] **エラー修正**: Blade構文とJavaScript競合の解決

### **Phase B: 人気タブ実装** - ✅完了（2025年1月実装）
- [x] **PostController@index修正**: 人気タブでいいね数順ソート実装
- [x] **タブ名調整**: 分かりやすい表記への調整
- [x] **動作確認**: 正常動作確認済み
- [x] **クリーンアップ**: 未使用コードの削除

## 一時停止中のタスク

### Phase 15: Google Maps API連携実装（一時停止）
- **停止理由**: Phase 16完了後に再開予定
- **残りタスク**: 
  - 地図スタイルのカスタマイズ
  - カスタムマーカーアイコン
  - インタラクティブ機能の強化
  - セキュリティ強化（APIキー制限設定）

## 問題のあるタスク

- [!] **Phase B実装時のルール違反**
  - 動作確認を行わずにtodo.mdを更新
  - 段階的実装の原則を無視
  - 初心者向け解説の不足

## 今後の予定タスク

### **Phase B: 人気タブ実装** - ⏳次のタスク
- **実装方針**: 段階的アプローチで一歩ずつ進める
- **動作確認**: 各ステップで必ず動作確認を実行
- **ルール遵守**: task-management.mdc の完了判定ルールを厳守

## 今後のアップデート方針（画像アップロード機能）
- 複数画像アップロード（サブ画像ギャラリー、ドラッグ＆ドロップ、並び替え等）は将来的な拡張候補。
- 現状は「1枚のみアップロード」でリリースし、リッチなUI/UXはリリース後の段階的アップデートで対応。

## メモ

- **ルール違反の反省**: 動作確認を行わずにtodo.mdを更新してしまった重大な違反
- **今後の方針**: 段階的アプローチで一歩ずつ進める
- **動作確認の必須化**: 各変更後に必ず動作確認を実行
- コメント削除のダイアログは標準confirm()のため、カスタムモーダル化しない限りautofocus制御不可
- UIアクセシビリティ改善は段階的に進める
- Google Mapsの警告（Marker非推奨、loading=async未使用）は現状の地図表示には影響なし。今後のリファクタリングで対応予定。
- レスポンシブ対応（スマホ・タブレット幅での地図高さ・UI崩れ）は未確認。必要に応じてTailwindのレスポンシブクラスや@mediaクエリで調整予定。
- **2025年6月29日**: Phase 16-1の大部分が完了し、残りはいいね機能の修正と検索機能の曖昧検索対応のみ
- **2025年1月**: Phase A完了、Phase B実装準備中
- **現在の優先タスク**: Phase B実装準備 → 段階的実装 → 動作確認
- **一時停止中のタスク**: Phase 15 Google Maps API連携実装（Phase 16完了後に再開予定）

## 環境情報

### 現在の環境状況
- **Docker環境**: 正常稼働中
  - portfolio_app (PHP 8.2.28)
  - portfolio_nginx (Nginx 1.18.0)
  - portfolio_mysql (MySQL)
- **Laravel**: 10.48.29
- **データベース**: マイグレーション完了（23個）
- **フロントエンド**: Vite + Tailwind CSS
- **アクセスURL**: http://localhost
- **本番ドメイン**: https://taste-retreat.com

### 確認済み機能
- アプリケーション起動: ✅
- データベース接続: ✅
- マイグレーション: ✅
- フロントエンドビルド: ✅
- Webサーバー: ✅

### ルールファイル構成（8つ）
- `.cursor/rules/core-rules.mdc`: 基本開発ルール（常に適用）
- `.cursor/rules/beginner-guidelines.mdc`: 初心者向け解説方針（常に適用）
- `.cursor/rules/laravel-backend.mdc`: Laravelバックエンド開発時のみ参照（AutoAttached）
- `.cursor/rules/tailwind-frontend.mdc`: フロントエンド開発時のみ参照（AutoAttached）
- `.cursor/rules/error-handling.mdc`: エラー対応時のみ参照（AgentRequested）
- `.cursor/rules/task-management.mdc`: タスク管理時のみ参照（AgentRequested）
- `.cursor/rules/knowledge-management.mdc`: 技術的ナレッジベース管理時のみ参照（AgentRequested）
- `.cursor/rules/qa-knowledge.mdc`: 開発Q&A記録時のみ参照（AgentRequested）

- ルールファイルが正常に作成されました
- タスク管理システムが稼働開始しました
- 環境セッティングが完了し、開発準備が整いました
- アプリケーションは http://localhost でアクセス可能です
- **現在の優先タスク**: Phase B実装準備 → 段階的実装 → 動作確認
- **一時停止中のタスク**: Phase 15 Google Maps API連携実装（Phase 16完了後に再開予定）
- リファクタリングの基本原則：1コンポーネント1機能、拡張性より単純性、可読性最優先、保守性重視、Tailwindクラス直接記述
- **新しいルール体系**: 8つのルールファイルで包括的な開発ガイドラインを構築
- **ルール見落とし防止**: 作業開始前に必ず全てのルールファイルを参照し、適用状況を確認
- **重要な教訓**: 動作確認を行わずにtodo.mdを更新してはいけない

## 現在のコンポーネント状況

### x-atoms.avatar コンポーネント
- **現状**: 機能改善完了
- **機能**: 
  - アバター画像表示（`$user->avatar_url`）
  - 頭文字表示（日本語対応、`AvatarHelper::getInitial()`）
  - サイズ調整（small, default, large）
  - プライベートアイコン表示（統合済み）
- **使用箇所**: 
  - `post-card.blade.php`（size="small"）
  - その他のコンポーネントで適切に使用中

### 通知ドロップダウンと/notifications一覧ページのUI統一（将来実装予定）
  - 現状は/notificationsへのリンクのみ設置
  - ドロップダウンと一覧の両立はUI不整合リスクがあるため、今後の課題として記録