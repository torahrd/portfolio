# TasteRetreat タスク管理

## 🎯 プロジェクト目標
- **最優先**: セキュリティリスクの解消
- **中期目標**: 収益化の実現（1年以内）
- **現在のフェーズ**: MVP完成に向けたセキュリティ強化

---

## 🔴 Phase 1: 緊急セキュリティ対応（1週間）

### 1.1 CSP完全対応 - commentSection実装【着手中】
**現状**: 新規コメントのみ動作、返信・削除機能が未対応
**TDD方式で実装**

#### 🔴 Red（テスト作成）✅ 完了
- [x] tests/Feature/CommentSectionCspTest.php作成
  - [x] 新規コメント投稿のテスト
  - [x] コメント返信機能のテスト
  - [x] コメント削除機能のテスト
  - [x] CSPエラーが発生しないことのテスト（手動確認用）
- [x] Factory作成（Shop, Post, Comment）
- [x] テストが正しく失敗することを確認

#### 🟢 Green（最小実装）✅ 完了
- [x] commentSection.jsのCSP対応完了
  - [x] 複雑な条件式をメソッド化（すでに実装済み）
  - [x] x-modelの代替実装（:value + @input使用）
  - [x] イベントハンドラーのメソッド化（実装済み）
- [x] app.jsでcommentSectionを有効化
- [x] API対応（/commentsエンドポイント追加）
  - [x] CommentController::storeGeneric実装
  - [x] JSON/AJAX対応の削除メソッド修正
- [x] テスト全6項目パス確認

#### 🟡 Refactor（品質改善）✅ 完了
- [✅] エラーハンドリングの統一（トランザクション、ログ記録）
- [✅] コードの最適化（重複コード削除、ヘルパーメソッド追加）
- [✅] Laravel Pintでの整形
- [✅] ブラウザでの動作確認（問題修正として実施済み）
  - [✅] コメント投稿・返信・削除が動作
  - [✅] CSPエラーが解消

#### 🔵 Enhancement（非同期処理の完全実装）✅ 完了
**目的**: モダンなUXを実現する完全非同期コメントシステム
**ベストプラクティス**: 
- insertAdjacentHTMLによるDOM操作（Vue.jsライクな実装）
- Axiosパターンのエラーハンドリング
- スクロール位置の保持

##### タスク詳細
- [x] フォームの非同期処理修正
  - [x] comment-formに@submit.prevent追加
  - [x] バリデーションエラーのアラート表示修正
- [x] DOM操作による部分更新実装
  - [x] submitCommentの非同期化（リロード削除）
  - [x] submitReplyの非同期化（リロード削除）
  - [x] insertAdjacentHTMLで新規コメント追加
- [x] UX改善
  - [x] ローディング状態の表示
  - [x] スクロール位置の保持
  - [x] アニメーション追加（fade-in効果）
- [x] エラーハンドリング強化
  - [x] ネットワークエラーの適切な表示
  - [x] バリデーションエラーの個別表示
- [ ] テスト追加（後日実施）
  - [ ] 非同期処理のE2Eテスト
  - [ ] DOM更新の確認テスト

#### ⚪ Commit（記録）✅ 完了
- [x] _docs/dev-log/2025-01-16_16-30_comment-async-csp.md作成
- [x] テスト実行確認（php artisan test）
- [ ] git commit & push（実施中）

### 1.2 プライベート投稿の権限管理
**現状**: 未実装、誰でも閲覧可能な状態

#### 🔴 Red（テスト作成）
- [ ] tests/Feature/PrivatePostAuthorizationTest.php作成
  - [ ] 非公開投稿が他ユーザーから見えないテスト
  - [ ] フォロワーのみ閲覧可能なテスト
  - [ ] 本人は常に閲覧可能なテスト

#### 🟢 Green（最小実装）
- [ ] PostPolicyの実装
- [ ] コントローラーでの認可チェック
- [ ] Bladeでの表示制御

#### 🟡 Refactor（品質改善）
- [ ] ポリシーの最適化
- [ ] N+1問題の解消

#### ⚪ Commit（記録）
- [ ] _docs/dev-log/2025-01-16_private-post-auth.md作成
- [ ] git commit & push

### 1.3 本番環境セキュリティ設定反映
**現状**: ローカルで設定済み、本番未反映

#### 🔴 Red（テスト作成）
- [ ] デプロイチェックリスト作成
- [ ] セキュリティヘッダー確認スクリプト

#### 🟢 Green（最小実装）
- [ ] git pull + composer install
- [ ] キャッシュクリア
- [ ] CORS設定確認
- [ ] プライバシーポリシー確認

#### 🟡 Refactor（品質改善）
- [ ] デプロイスクリプト作成
- [ ] 自動化の検討

#### ⚪ Commit（記録）
- [ ] _docs/dev-log/2025-01-16_production-security.md作成
- [ ] git commit & push

### 1.4 バックアップシステム構築
**現状**: 手動バックアップのみ

#### 🔴 Red（テスト作成）
- [ ] バックアップ動作確認テスト

#### 🟢 Green（最小実装）
- [ ] spatie/laravel-backup インストール
- [ ] 設定ファイル作成
- [ ] cronジョブ設定

#### 🟡 Refactor（品質改善）
- [ ] バックアップ先の最適化
- [ ] 通知設定

#### ⚪ Commit（記録）
- [ ] _docs/dev-log/2025-01-16_backup-system.md作成
- [ ] git commit & push

---

## 🟡 Phase 2: UI/UX改善とリリース準備（2週間）

### 2.1 投稿作成フローの簡素化
**目標**: 3ステップ以内で投稿完了

#### タスク詳細
- [ ] 現状のフロー分析
- [ ] UI設計・ワイヤーフレーム作成
- [ ] 実装（TDD方式）
- [ ] ユーザビリティテスト

### 2.2 モバイル最適化
**現状**: 基本的なレスポンシブ対応のみ

#### タスク詳細
- [ ] モバイルでの問題点調査
- [ ] タッチ操作の最適化
- [ ] 画面サイズ別の調整
- [ ] パフォーマンス最適化

### 2.3 メンション機能の修復
**現状**: 動作していない

#### タスク詳細
- [ ] 現状の問題分析
- [ ] XSS対策を含めた実装
- [ ] テスト作成
- [ ] 動作確認

### 2.4 ランディングページ完成
**現状**: 設計書完成済み、実装未着手

#### タスク詳細
- [ ] HTMLマークアップ
- [ ] スタイリング（TailwindCSS）
- [ ] インタラクション実装
- [ ] SEO最適化

---

## 🟢 Phase 3: 機能拡張（1ヶ月後〜）

### 3.1 タグ・カテゴリ機能
- [ ] データベース設計
- [ ] CRUD実装
- [ ] 検索機能との連携
- [ ] UI実装

### 3.2 エリア検索機能
- [ ] 位置情報取得
- [ ] 地理空間検索実装
- [ ] Google Maps連携強化
- [ ] UI実装

### 3.3 24店舗制限の本格実装
- [ ] 24節気マスタデータ作成
- [ ] 制限ロジック実装
- [ ] UI/UXの実装
- [ ] テスト

### 3.4 検索機能の強化
- [ ] 全文検索実装
- [ ] フィルター機能
- [ ] ソート機能
- [ ] 検索履歴

---

## ⚪ Phase 4: 収益化準備（3ヶ月後〜）

### 4.1 有料プラン機能
- [ ] 料金プラン設計
- [ ] 決済システム導入（Stripe）
- [ ] サブスクリプション管理
- [ ] 請求書発行

### 4.2 海外展開準備
- [ ] 多言語対応（i18n）
- [ ] 通貨対応
- [ ] タイムゾーン対応
- [ ] 法的要件確認

---

## 📝 完了済みタスク（最新5件）
- [x] 要件定義書（spec.md）作成
- [x] アーキテクチャ詳細（architecture.md）作成
- [x] CLAUDE.mdのLaravel仕様への修正
- [x] CSP対応状況の調査
- [x] ベストプラクティスの調査

※ 過去の完了タスクは `todo-archive.md` を参照

---

## 🚫 ブロッカー・課題
- Alpine.js CSPビルドでのx-model非対応問題
- 本番環境へのアクセス手順の確認が必要
- テスト環境の整備が不十分

---

## 📊 進捗サマリー
- **全体進捗**: 60%（MVP機能は実装済み、品質向上フェーズ）
- **セキュリティ**: 70%（基本対策済み、CSP対応中）
- **UI/UX**: 50%（基本実装済み、最適化必要）
- **収益化**: 0%（未着手）

---

## 🔧 開発環境情報
- **Laravel**: 10.48.29
- **PHP**: 8.2.28
- **MySQL**: 8.0
- **Docker**: 稼働中
- **本番URL**: https://taste-retreat.com

---

## 📚 参考資料
- [要件定義書](../spec.md)
- [アーキテクチャ詳細](../architecture.md)
- [CLAUDE.md](../claude.md)
- [LP設計書](../LP_DESIGN_INTERVIEW.md)
- [技術Q&A](docs/knowledge-base.md)

---

最終更新: 2025-01-16