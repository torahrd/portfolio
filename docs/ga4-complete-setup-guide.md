# GA4完全設定ガイド - TasteRetreat

## 📋 設定チェックリスト

### Phase 1: 本番環境設定（必須）
- [ ] 本番サーバーの.env設定
- [ ] キャッシュクリア
- [ ] 動作確認

### Phase 2: GA4管理画面設定（必須）
- [ ] 内部トラフィック除外設定
- [ ] ボットフィルタリング有効化
- [ ] データ保持期間の設定

### Phase 3: 動作検証（必須）
- [ ] リアルタイムレポート確認
- [ ] Cookie同意機能の確認
- [ ] 開発環境からのアクセス除外確認

### Phase 4: 追加設定（推奨）
- [ ] 拡張計測の設定
- [ ] コンバージョンイベントの設定
- [ ] カスタムディメンションの設定

---

## 🚀 Phase 1: 本番環境設定（15分）

### ステップ1: 本番サーバーにSSH接続

```bash
ssh bitnami@taste-retreat.com
```

パスワードまたはSSHキーで認証してください。

### ステップ2: プロジェクトディレクトリに移動

```bash
cd /opt/bitnami/projects/taste-retreat
```

### ステップ3: .envファイルを編集

```bash
sudo nano .env
```

ファイルの最後に以下を追加：

```env
# Google Analytics 4 Settings
GA4_ENABLED=true
GA4_MEASUREMENT_ID=G-D9H5J51Y45
ANALYTICS_DEBUG=false
```

保存: `Ctrl+O` → `Enter` → `Ctrl+X`

### ステップ4: キャッシュクリアと再構築

```bash
# 設定キャッシュをクリア
php artisan config:clear
php artisan cache:clear
php artisan view:clear
php artisan route:clear

# 設定を再キャッシュ（本番環境で推奨）
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### ステップ5: 設定確認

```bash
php artisan tinker
```

以下を実行して確認：
```php
config('analytics.enabled')
// true が表示されればOK

config('analytics.measurement_id')
// "G-D9H5J51Y45" が表示されればOK

exit
```

### ステップ6: Webサーバー再起動（念のため）

```bash
sudo /opt/bitnami/ctlscript.sh restart apache
```

---

## 📊 Phase 2: GA4管理画面設定（20分）

### ステップ1: GA4プロパティにアクセス

1. [Google Analytics](https://analytics.google.com) にログイン
2. 「TasteRetreat」プロパティを選択
3. 左下の「⚙️管理」をクリック

### ステップ2: 内部トラフィックの除外

#### A. 内部トラフィックの定義

1. 「管理」→「データストリーム」→ 該当ストリームをクリック
2. 「タグ設定を行う」→「設定」→「内部トラフィックの定義」
3. 「作成」をクリック
4. 以下を設定：

```
ルール名: 開発環境
トラフィックタイプ値: internal

IPアドレスの条件:
- マッチタイプ: IPアドレスが次と等しい
- 値: あなたの開発環境のIPアドレス
  （確認方法: https://www.whatismyip.com/ ）

追加条件（ホスト名）:
- パラメータ: hostname
- マッチタイプ: 次を含む
- 値: localhost

追加でもう一つ:
- パラメータ: hostname  
- マッチタイプ: 次を含む
- 値: 127.0.0.1
```

5. 「作成」をクリック

#### B. データフィルタの作成

1. 「管理」→「データ設定」→「データフィルタ」
2. 「フィルタを作成」をクリック
3. 以下を設定：

```
データフィルタ名: 内部トラフィックを除外
フィルタオペレーション: 除外
フィルタの状態: 有効
パラメータ値: internal
```

4. 「フィルタを作成」をクリック

### ステップ3: 基本設定の確認

#### A. データ保持期間

1. 「管理」→「データ設定」→「データ保持」
2. 「イベントデータの保持」を「14か月」に設定
3. 「新しいアクティビティをリセット」をON
4. 「保存」をクリック

#### B. Google シグナル

1. 「管理」→「データ設定」→「データ収集」
2. 「Google シグナルのデータ収集」をON
3. 地域の設定を確認（日本を含む）

#### C. 拡張計測

1. 「管理」→「データストリーム」→ 該当ストリームをクリック
2. 「拡張計測」の歯車アイコンをクリック
3. 以下を有効化：
   - ページビュー（自動）
   - スクロール数
   - 離脱クリック
   - サイト内検索
   - フォームの操作
   - 動画エンゲージメント
   - ファイルのダウンロード

---

## ✅ Phase 3: 動作検証（10分）

### ステップ1: ブラウザでの事前準備

1. ブラウザのシークレット/プライベートモードを開く
2. デベロッパーツール（F12）を開く
3. Networkタブを選択
4. 「Preserve log」にチェック

### ステップ2: 本番サイトでの確認

1. https://taste-retreat.com にアクセス
2. Cookie同意バナーが表示されることを確認
3. 「同意する」をクリック

### ステップ3: データ送信の確認

Networkタブで以下を確認：
- `gtag/js?id=G-D9H5J51Y45` → Status: 200
- `google-analytics.com/g/collect` → Status: 204

### ステップ4: GA4リアルタイムレポート確認

1. GA4管理画面に戻る
2. 「レポート」→「リアルタイム」
3. 以下を確認：
   - ユーザー数: 1以上
   - イベント数の増加
   - ページパスに「/」が表示

### ステップ5: 開発環境からのアクセステスト

1. 開発環境（localhost）でサイトを開く
2. GA4リアルタイムレポートを確認
3. **データが表示されない**ことを確認（正常）

---

## 🎯 Phase 4: 追加設定（推奨・30分）

### カスタムイベントの実装準備

#### ステップ1: 重要イベントの定義

1. 「管理」→「イベント」
2. 既存のイベントを確認
3. 以下のイベントをマーク（重要イベントとして）：
   - `page_view`
   - `scroll` （90%到達）
   - `click` （外部リンク）

#### ステップ2: コンバージョンの設定

1. 「管理」→「コンバージョン」
2. 「新しいコンバージョンイベント」をクリック
3. 以下を追加（実装後に有効化）：
   - `sign_up` （新規登録）
   - `login` （ログイン）
   - `create_post` （投稿作成）
   - `add_favorite_shop` （お気に入り追加）

### オーディエンスの作成

1. 「管理」→「オーディエンス」
2. 「新しいオーディエンス」→「カスタムオーディエンスを作成」
3. 以下を作成：

```
名前: アクティブユーザー
条件: 過去7日間に3回以上訪問

名前: 新規ユーザー
条件: first_visit イベントが過去30日間に発生

名前: エンゲージユーザー
条件: スクロール率90%以上 AND セッション時間3分以上
```

---

## 🔧 トラブルシューティング

### データが表示されない場合

#### 1. 本番環境の設定確認
```bash
# 本番サーバーで実行
php artisan tinker
>>> config('analytics.enabled')
>>> config('analytics.measurement_id')
```

#### 2. ブラウザコンソールで確認
```javascript
// ページを開いてコンソールで実行
typeof gtag
// "function" が返ればOK

// テストイベント送信
gtag('event', 'test_event', {
  'event_category': 'debug'
});
```

#### 3. GA4 DebugViewで確認
1. 「管理」→「DebugView」
2. デバイスが表示されるか確認

### Cookie同意バナーが機能しない場合

1. Alpine.jsのビルドを確認：
```bash
npm run build
```

2. CSPエラーを確認（ブラウザコンソール）

3. 本番環境でJavaScriptエラーがないか確認

---

## 📝 メンテナンス情報

### 定期確認項目（月1回）

1. **データ品質チェック**
   - 不審なトラフィック急増がないか
   - リファラースパムがないか
   - 内部トラフィックが除外されているか

2. **レポート確認**
   - ユーザー獲得レポート
   - エンゲージメントレポート
   - 収益化レポート（将来的に）

### アップデート時の注意

1. GA4の仕様変更をGoogleの公式ブログで確認
2. Cookie規制の動向を確認（特にEU圏）
3. プライバシー法の更新を確認

---

## 📞 サポート情報

### Google Analytics ヘルプ
- [公式ヘルプセンター](https://support.google.com/analytics)
- [GA4 移行ガイド](https://support.google.com/analytics/answer/10089681)

### 開発チーム連絡先
- 技術的な問題: Slackの#tech-supportチャンネル
- GA4設定の相談: データ分析チーム

最終更新: 2025年1月